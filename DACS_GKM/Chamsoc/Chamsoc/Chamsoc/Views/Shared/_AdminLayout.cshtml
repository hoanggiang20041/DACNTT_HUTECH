@inject Chamsoc.Data.AppDbContext DbContext
@{
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin/admin-sidebar.css" />
    @await RenderSectionAsync("Styles", required: false)
}

<div class="container-fluid p-0">
    <div class="d-flex">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-white">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <h6 class="sidebar-title">
                    <i class="fas fa-hospital-user"></i>
                    <span>GKM Care</span>
                </h6>
                <p class="sidebar-subtitle">Hệ thống quản trị</p>
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Thu gọn menu">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>

            <!-- Navigation Sections -->
            <div class="position-sticky" style="top: 0; padding-top: 1rem;">
                <!-- Quản Lý Chung -->
                <div class="nav-section">
                    <h6 class="sidebar-heading">
                        <span class="menu-title">Quản Lý Chung</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link @(ViewContext.RouteData.Values["Action"]?.ToString() == "ManageUsers" ? "active" : "")"
                               asp-controller="Admin" asp-action="ManageUsers"
                               data-tooltip="Người dùng">
                                <i class="fas fa-users"></i>
                                <span class="menu-title">Người dùng</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(ViewContext.RouteData.Values["Action"]?.ToString() == "ManageComplaints" ? "active" : "")"
                               asp-controller="Admin" asp-action="ManageComplaints"
                               data-tooltip="Khiếu nại">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="menu-title">Khiếu nại</span>
                                @{
                                    var unreadComplaints = 0;
                                    if (DbContext != null)
                                    {
                                        try
                                        {
                                            unreadComplaints = DbContext.Notifications
                                                .Where(n => !n.IsRead && n.Message.Contains("Khiếu nại"))
                                                .Count();
                                        }
                                        catch { }
                                    }
                                }
                                @if (unreadComplaints > 0)
                                {
                                    <span class="nav-badge">@unreadComplaints</span>
                                }
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Quản Lý Tài Chính -->
                <div class="nav-section">
                    <h6 class="sidebar-heading">
                        <span class="menu-title">Quản Lý Tài Chính</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link @(ViewContext.RouteData.Values["Action"]?.ToString() == "TransactionStats" ? "active" : "")"
                               asp-controller="Admin" asp-action="TransactionStats"
                               data-tooltip="Thống kê giao dịch">
                                <i class="fas fa-chart-line"></i>
                                <span class="menu-title">Thống kê giao dịch</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(ViewContext.RouteData.Values["Action"]?.ToString() == "ManagePayments" ? "active" : "")"
                               asp-controller="Admin" asp-action="ManagePayments"
                               data-tooltip="Quản lý thanh toán">
                                <i class="fas fa-money-bill-wave"></i>
                                <span class="menu-title">Quản lý thanh toán</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(ViewContext.RouteData.Values["Action"]?.ToString() == "BalanceHistory" ? "active" : "")"
                               asp-controller="Admin" asp-action="BalanceHistory"
                               data-tooltip="Lịch sử số dư">
                                <i class="fas fa-wallet"></i>
                                <span class="menu-title">Lịch sử số dư</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mobile Sidebar Toggle -->
            <button class="btn btn-link text-dark p-2 d-md-none mb-3" id="mobileSidebarToggle" style="border-radius: 10px; background: rgba(0, 123, 255, 0.1);">
                        <i class="fas fa-bars"></i>
                    </button>

            <!-- Page Header -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1" style="font-weight: 700; color: #343a40;">@ViewData["Title"]</h1>
                    <p class="text-muted mb-0" style="font-size: 0.875rem;">Quản trị hệ thống chăm sóc sức khỏe</p>
                </div>
                <div class="btn-toolbar mb-md-0 mt-3 mt-md-0">
                    @RenderSection("Toolbar", required: false)
                </div>
            </div>

            @RenderBody()
        </main>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            const body = document.body;
            const mainContent = document.querySelector('.main-content');

            // Initialize sidebar state
            function initializeSidebar() {
                const savedState = localStorage.getItem('sidebarCollapsed');
                const isMobile = window.innerWidth < 768;
                
                if (!isMobile && savedState === 'true') {
                    sidebar.classList.add('collapsed');
                    body.classList.add('sidebar-collapsed');
                }
            }
                
            // Toggle sidebar function
            function toggleSidebar(e) {
                if (e) {
                    e.preventDefault();
                e.stopPropagation();
                }
                
                const isMobile = window.innerWidth < 768;

                if (isMobile) {
                    // Mobile: toggle show class
                    sidebar.classList.toggle('show');
                    sidebar.classList.remove('collapsed');
                    body.classList.remove('sidebar-collapsed');
                } else {
                    // Desktop: toggle collapsed class
                    sidebar.classList.toggle('collapsed');
                    body.classList.toggle('sidebar-collapsed');
                    
                    // Save state
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                }
            }

            // Event listeners
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }

            if (mobileSidebarToggle) {
                mobileSidebarToggle.addEventListener('click', toggleSidebar);
            }

            // Close mobile sidebar when clicking outside
            document.addEventListener('click', function(e) {
                const isMobile = window.innerWidth < 768;
                if (isMobile && 
                    sidebar.classList.contains('show') &&
                    !sidebar.contains(e.target) &&
                    !mobileSidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            });

            // Handle window resize
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    const isMobile = window.innerWidth < 768;
                    
                    if (isMobile) {
                        // Reset desktop state in mobile
                        sidebar.classList.remove('collapsed');
                        body.classList.remove('sidebar-collapsed');
                    } else {
                        // Reset mobile state in desktop
                        sidebar.classList.remove('show');
                        
                        // Restore desktop state
                        const savedState = localStorage.getItem('sidebarCollapsed');
                        if (savedState === 'true') {
                            sidebar.classList.add('collapsed');
                            body.classList.add('sidebar-collapsed');
                        }
                    }
                }, 250);
            });

            // Initialize on page load
            initializeSidebar();

            // Smooth scroll for sidebar
            sidebar.style.scrollBehavior = 'smooth';
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
} 
