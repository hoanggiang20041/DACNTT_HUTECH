@model Chamsoc.Models.Senior
@{
    ViewData["Title"] = "Cập Nhật Hồ Sơ Người Cần Chăm Sóc";
    string currentUserRole = ViewBag.CurrentUserRole;
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-user-edit me-2"></i>Cập nhật thông tin cá nhân
                        </h5>
                        @if (Model.IsVerified)
                        {
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check-circle me-1"></i>Đã xác minh
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-warning fs-6">
                                <i class="fas fa-clock me-1"></i>Chưa xác minh
                            </span>
                        }
                    </div>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateProfileSenior" asp-controller="Account" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        <input type="hidden" name="id" value="@ViewBag.User.Id" />
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-section mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-info-circle me-2"></i>Thông tin cơ bản
                                    </h6>
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Họ và tên</label>
                                        <input type="text" class="form-control" id="name" name="name" value="@Model.Name" required />
                                        <div class="invalid-feedback">
                                            Vui lòng nhập họ và tên.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="age" class="form-label">Tuổi</label>
                                        <input type="number" class="form-control" id="age" name="age" value="@Model.Age" min="1" required />
                                        <div class="invalid-feedback">
                                            Vui lòng nhập tuổi hợp lệ (lớn hơn 0).
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">Giới tính</label>
                                        <select class="form-control" id="gender" name="gender" required>
                                            <option value="">Chọn giới tính</option>
                                            @if (ViewBag.User?.Gender == "Nam")
                                            {
                                                <option value="Nam" selected>Nam</option>
                                            }
                                            else
                                            {
                                                <option value="Nam">Nam</option>
                                            }
                                            @if (ViewBag.User?.Gender == "Nữ")
                                            {
                                                <option value="Nữ" selected>Nữ</option>
                                            }
                                            else
                                            {
                                                <option value="Nữ">Nữ</option>
                                            }
                                            @if (ViewBag.User?.Gender == "Khác")
                                            {
                                                <option value="Khác" selected>Khác</option>
                                            }
                                            else
                                            {
                                                <option value="Khác">Khác</option>
                                            }
                                        </select>
                                        <div class="invalid-feedback">
                                            Vui lòng chọn giới tính.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="address" class="form-label">Địa chỉ</label>
                                        <div class="position-relative">
                                            <textarea class="form-control" id="address" name="address" rows="3" required placeholder="Nhập địa chỉ để xem gợi ý...">@(ViewBag.User?.Address ?? "")</textarea>
                                            <div id="addressSuggestions" class="address-suggestions"></div>
                                        </div>
                                        <div class="d-flex gap-2 mt-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="autoLocationBtn">
                                                <i class="fas fa-map-marker-alt me-1"></i>Cập nhật địa chỉ tự động
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAddressBtn">
                                                <i class="fas fa-eraser me-1"></i>Xóa địa chỉ
                                            </button>
                                        </div>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập địa chỉ.
                                        </div>
                                    </div>
                                    <div class="mb-3 position-relative">
                                        <label for="careNeeds" class="form-label">Tình trạng bệnh</label>
                                        <input type="text" class="form-control" id="careNeeds" name="careNeeds" value="@Model.CareNeeds" required autocomplete="off" />
                                        <div class="invalid-feedback">
                                            Vui lòng nhập tình trạng bệnh.
                                        </div>
                                        <div id="careNeedsSuggestions" class="list-group mt-2" style="display:none;"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="info-section mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-address-card me-2"></i>Thông tin liên hệ
                                    </h6>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" name="email" value="@ViewBag.User.Email" required />
                                        <div class="invalid-feedback">
                                            Vui lòng nhập email hợp lệ.
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="contact" class="form-label">Số điện thoại</label>
                                        <input type="text" class="form-control" id="contact" name="contact" value="@ViewBag.User.PhoneNumber" required maxlength="10" pattern="\d{10}" />
                                        <div class="invalid-feedback">
                                            Vui lòng nhập số điện thoại gồm đúng 10 chữ số.
                                        </div>
                                    </div>
                                </div>

                                <div class="info-section mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-money-bill-wave me-2"></i>Thông tin chi phí
                                    </h6>
                                    <div class="mb-3">
                                        <label for="price" class="form-label">Chi phí có thể chi trả (1 giờ) (VNĐ)</label>
                                        <input type="text" class="form-control" id="price" name="priceDisplay" value="@Model.Price.ToString("N0")" required />
                                        <input type="hidden" id="priceHidden" name="price" value="@Model.Price" />
                                        <span class="text-danger" id="priceError"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label for="status" class="form-label">Trạng thái</label>
                                        <select class="form-control" id="status" name="status">
                                            @if (Model.Status)
                                            {
                                                <option value="true" selected>Sẵn sàng</option>
                                                <option value="false">Đang bận</option>
                                            }
                                            else
                                            {
                                                <option value="true">Sẵn sàng</option>
                                                <option value="false" selected>Đang bận</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="info-section mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-lock me-2"></i>Bảo mật
                                    </h6>
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">Mật khẩu hiện tại (nếu muốn đổi mật khẩu)</label>
                                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" />
                                    </div>
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">Mật khẩu mới (nếu muốn đổi mật khẩu)</label>
                                        <input type="password" class="form-control" id="newPassword" name="newPassword" />
                                    </div>
                                </div>

                                <div class="info-section mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-image me-2"></i>Ảnh đại diện
                                    </h6>
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*" />
                                        @if (!string.IsNullOrEmpty(Model.AvatarUrl))
                                        {
                                            <div class="mt-2">
                                                <img src="@Model.AvatarUrl" alt="Avatar" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 justify-content-center">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Cập nhật
                            </button>
                            @if (currentUserRole == "Admin")
                            {
                                <a asp-action="ManageUsers" asp-controller="Admin" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                </a>
                            }
                            else if (currentUserRole == "Senior")
                            {
                                <a asp-action="ListCaregivers" asp-controller="Caregivers" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                </a>
                            }
                            else if (currentUserRole == "Caregiver")
                            {
                                <a asp-action="ListSeniors" asp-controller="Seniors" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                </a>
                            }
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 1rem;
        overflow: hidden;
    }
    .card-header {
        border-bottom: none;
    }
    .info-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
    }
    .badge {
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    .btn {
        padding: 0.5rem 1.5rem;
        border-radius: 0.5rem;
    }
    
    .address-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .address-suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

    .address-suggestion-item:hover {
        background-color: #f8f9fa;
    }

    .address-suggestion-item:last-child {
        border-bottom: none;
    }

    .address-suggestion-item .suggestion-text {
        font-size: 14px;
        color: #333;
    }

    .address-suggestion-item .suggestion-detail {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
        font-weight: 500;
    }
    .alert {
        border-radius: 0.5rem;
        border: none;
    }
    #careNeedsSuggestions {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #careNeedsSuggestions div {
        padding: 0.5rem;
        cursor: pointer;
        background: white;
        border: 1px solid #dee2e6;
    }
    #careNeedsSuggestions div:hover {
        background-color: #f8f9fa;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const priceInput = document.getElementById('price');
            const priceHidden = document.getElementById('priceHidden');
            const priceError = document.getElementById('priceError');
            const contactInput = document.getElementById('contact');
            const careNeedsInput = document.getElementById('careNeeds');
            const form = document.querySelector('form');

            // Danh sách gợi ý tình trạng bệnh
                       const diseases = [
            "Tiểu đường",
            "Cao huyết áp",
            "Tim mạch",
            "Hô hấp",
            "Thần kinh",
            "Ung thư",
            "Béo phì",
            "Cholesterol cao",
            "Viêm gan",
            "Suy thận",
            "Nhiễm trùng đường tiểu",
            "Hen suyễn",
            "Dị ứng",
            "Viêm phế quản",
            "Viêm phổi",
            "Đột quỵ",
            "Bệnh Alzheimer",
            "Bệnh Parkinson",
            "Bệnh gout",
            "Loãng xương",
            "Bệnh Crohn",
            "Viêm đại tràng",
            "Bệnh Addison",
            "Bệnh lupus",
            "Viêm khớp dạng thấp",
            "Bệnh celiac",
            "Tiểu đường thai kỳ",
            "Xơ cứng teo cơ",
            "Bệnh phổi tắc nghẽn mạn tính (COPD)",
            "Trầm cảm",
            "Rối loạn lo âu",
            "Viêm tủy sống",
            "Bệnh tim thiếu máu cục bộ",
            "Bệnh van tim",
            "Bệnh mạch vành",
            "Bệnh thận đa nang",
            "Viêm gan siêu vi B",
            "Viêm gan siêu vi C",
            "Nhiễm HIV/AIDS",
            "Viêm khớp",
            "Bệnh tăng nhãn áp",
            "Bệnh tiểu đường loại 1",
            "Bệnh tiểu đường loại 2",
            "Bệnh mạch máu não",
            "Bệnh hạch bạch huyết",
            "Bệnh tiểu đường không kiểm soát",
            "Bệnh tâm thần phân liệt",
            "Rối loạn lưỡng cực",
            "Bệnh tự miễn",
            "Viêm loét đại tràng",
            "Bệnh động kinh",
            "Rối loạn ăn uống",
            "Bệnh tim bẩm sinh",
            "Bệnh phình động mạch",
            "Bệnh thận mạn tính",
            "Bệnh gan nhiễm mỡ",
            "Bệnh xơ gan",
            "Bệnh loãng xương",
            "Rối loạn giấc ngủ",
            "Bệnh vảy nến",
            "Bệnh eczema",
            "Bệnh trào ngược dạ dày thực quản",
            "Bệnh tiêu chảy mãn tính",
            "Bệnh viêm tụy",
            "Bệnh viêm mũi dị ứng",
            "Bệnh viêm xoang",
            "Bệnh nhiễm trùng nấm",
            "Bệnh nhiễm trùng ký sinh trùng",
            "Bệnh u xơ tử cung",
            "Bệnh u nang buồng trứng",
            "Bệnh sỏi thận",
            "Bệnh sỏi mật",
            "Bệnh trĩ",
            "Bệnh viêm dạ dày",
            "Bệnh viêm ruột thừa",
            "Bệnh suy giảm miễn dịch",
            "Bệnh viêm da",
            "Bệnh mề đay",
            "Bệnh chàm",
            "Bệnh mụn trứng cá",
            "Bệnh hôi miệng",
            "Bệnh viêm lợi",
            "Bệnh sâu răng",
            "Bệnh hẹp động mạch",
            "Bệnh suy tim",
            "Bệnh nhồi máu cơ tim",
            "Bệnh suy thượng thận",
            "Bệnh viêm màng não",
            "Bệnh viêm tim",
            "Bệnh rối loạn tiêu hóa",
            "Bệnh hội chứng ruột kích thích",
            "Bệnh viêm bàng quang",
            "Bệnh viêm thực quản",
            "Bệnh viêm gan tự miễn",
            "Bệnh rối loạn thần kinh",
            "Bệnh viêm phổi do vi khuẩn",
            "Bệnh viêm phổi do virus",
            "Bệnh viêm màng phổi",
            "Bệnh viêm phổi kẽ",
            "Bệnh hen phế quản",
            "Bệnh xơ phổi",
            "Bệnh viêm mạch máu",
            "Bệnh xơ cứng",
            "Bệnh viêm khớp gối",
            "Bệnh viêm khớp cổ tay",
            "Bệnh viêm khớp vai",
            "Bệnh viêm khớp ngón tay",
            "Bệnh viêm khớp hông",
            "Bệnh viêm khớp cột sống",
            "Bệnh viêm khớp lưng",
            "Bệnh viêm khớp gót chân",
            "Bệnh viêm khớp bàn chân",
            "Bệnh viêm gân",
            "Bệnh đau thần kinh tọa",
            "Bệnh thoát vị đĩa đệm",
            "Bệnh thoái hóa cột sống",
            "Bệnh đau lưng mãn tính",
            "Bệnh đau đầu",
            "Bệnh đau nửa đầu",
            "Bệnh chóng mặt",
            "Bệnh ù tai",
            "Bệnh viêm tai giữa",
            "Bệnh viêm mũi",
            "Bệnh viêm họng",
            "Bệnh viêm amidan",
            "Bệnh viêm phổi tắc nghẽn mạn tính",
            "Bệnh viêm phế quản cấp tính",
            "Bệnh viêm phế quản mạn tính",
            "Bệnh viêm phổi do hóa chất",
            "Bệnh viêm phổi do dị ứng",
            "Bệnh viêm gan do rượu",
            "Bệnh viêm gan do thuốc",
            "Bệnh viêm gan do virus",
            "Bệnh viêm gan do ký sinh trùng",
            "Bệnh viêm tuyến giáp",
            "Bệnh cường giáp",
            "Bệnh suy giáp",
            "Bệnh u tuyến giáp",
            "Bệnh viêm thận",
            "Bệnh viêm niệu đạo",
            "Bệnh viêm bàng quang mãn tính",
            "Bệnh viêm bàng quang cấp tính",
            "Bệnh viêm kết mạc",
            "Bệnh mù màu",
            "Bệnh đục thủy tinh thể",
            "Bệnh glaucom",
            "Bệnh khô mắt",
            "Bệnh thoái hóa điểm vàng",
            "Bệnh ưa chảy máu",
            "Bệnh thiếu máu",
            "Bệnh thalassemia",
            "Bệnh huyết tán",
            "Bệnh thiếu vitamin B12",
            "Bệnh thiếu sắt",
            "Bệnh viêm tắc tĩnh mạch",
            "Bệnh trào ngược thực quản",
            "Bệnh loét dạ dày",
            "Bệnh viêm túi mật",
            "Bệnh tràn dịch màng phổi",
            "Bệnh viêm màng phổi",
            "Bệnh tràn dịch màng tim",
            "Bệnh viêm màng ngoài tim",
            "Bệnh đau bụng",
            "Bệnh khó tiêu",
            "Bệnh buồn nôn",
            "Bệnh nôn mửa"
        ]

            // Hàm hiển thị gợi ý
            function showSuggestions(inputElement, suggestions) {
                const existingSuggestions = document.getElementById('careNeedsSuggestions');
                if (existingSuggestions) {
                    existingSuggestions.remove();
                }

                if (suggestions.length > 0) {
                    const suggestionsDiv = document.createElement('div');
                    suggestionsDiv.id = 'careNeedsSuggestions';
                    suggestionsDiv.style.width = inputElement.offsetWidth + 'px';

                    suggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.textContent = suggestion;
                        suggestionItem.addEventListener('click', function () {
                            inputElement.value = suggestion;
                            suggestionsDiv.remove();
                        });
                        suggestionsDiv.appendChild(suggestionItem);
                    });

                    inputElement.parentElement.appendChild(suggestionsDiv);
                }
            }

            // Autocomplete cho trường careNeeds
            if (careNeedsInput) {
                careNeedsInput.addEventListener('focus', function () {
                    showSuggestions(careNeedsInput, diseases);
                });

                careNeedsInput.addEventListener('input', function (e) {
                    const value = e.target.value.toLowerCase();
                    const suggestions = diseases.filter(disease => disease.toLowerCase().includes(value));
                    showSuggestions(careNeedsInput, suggestions);
                });

                document.addEventListener('click', function (e) {
                    if (e.target !== careNeedsInput) {
                        const suggestionsDiv = document.getElementById('careNeedsSuggestions');
                        if (suggestionsDiv) {
                            suggestionsDiv.remove();
                        }
                    }
                });
            }

            // Định dạng số khi hiển thị (thêm dấu chấm phân cách hàng nghìn)
            function formatNumber(value) {
                return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            // Loại bỏ định dạng để lấy giá trị số thô
            function parseNumber(value) {
                return parseFloat(value.replace(/\./g, '')) || 0;
            }

            // Định dạng giá trị ban đầu cho price
            priceInput.value = formatNumber(parseFloat(priceInput.value.replace(/\./g, '')));

            // Xử lý khi người dùng nhập price
            priceInput.addEventListener('input', function () {
                let rawValue = parseNumber(this.value);
                if (isNaN(rawValue) || rawValue < 0) {
                    priceError.textContent = 'Giá phải là số không âm.';
                    priceHidden.value = '';
                } else {
                    priceError.textContent = '';
                    this.value = formatNumber(rawValue);
                    priceHidden.value = rawValue;
                }
            });

            priceInput.addEventListener('change', function () {
                let rawValue = parseNumber(this.value);
                this.value = formatNumber(rawValue);
                priceHidden.value = rawValue;
            });

            // Kiểm tra real-time khi nhập số điện thoại
            contactInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/[^0-9]/g, ''); // Chỉ giữ lại số
                e.target.value = value;
                if (value.length > 10) {
                    e.target.value = value.slice(0, 10);
                }
                if (value.length !== 10) {
                    e.target.classList.add('is-invalid');
                } else {
                    e.target.classList.remove('is-invalid');
                }
            });

            // Validation khi submit form
            form.addEventListener('submit', function (e) {
                let name = document.getElementById('name').value;
                let age = document.getElementById('age').value;
                let gender = document.getElementById('gender').value;
                let address = document.getElementById('address').value;
                let careNeeds = document.getElementById('careNeeds').value;
                let email = document.getElementById('email').value;
                let contact = document.getElementById('contact').value;
                let price = document.getElementById('priceHidden').value;
                let errors = [];

                form.querySelectorAll('.is-invalid').forEach(element => element.classList.remove('is-invalid'));

                console.log("Name:", name);
                console.log("Age:", age);
                console.log("Gender:", gender);
                console.log("Address:", address);
                console.log("CareNeeds:", careNeeds);
                console.log("Email:", email);
                console.log("Contact:", contact);
                console.log("Price:", price);

                const phoneRegex = /^\d{10}$/;
                if (!contact || !phoneRegex.test(contact)) {
                    errors.push(`Số điện thoại phải gồm đúng 10 chữ số. Giá trị hiện tại: "${contact}"`);
                    document.getElementById('contact').classList.add('is-invalid');
                }

                if (!name || name.trim() === '') {
                    errors.push(`Họ và tên không hợp lệ. Giá trị hiện tại: "${name}"`);
                    document.getElementById('name').classList.add('is-invalid');
                }

                if (!age || parseInt(age) <= 0) {
                    errors.push(`Tuổi không hợp lệ. Giá trị hiện tại: "${age}"`);
                    document.getElementById('age').classList.add('is-invalid');
                }

                if (!gender || gender.trim() === '') {
                    errors.push(`Vui lòng chọn giới tính. Giá trị hiện tại: "${gender}"`);
                    document.getElementById('gender').classList.add('is-invalid');
                }

                if (!address || address.trim() === '') {
                    errors.push(`Địa chỉ không hợp lệ. Giá trị hiện tại: "${address}"`);
                    document.getElementById('address').classList.add('is-invalid');
                }

                if (!careNeeds || careNeeds.trim() === '') {
                    errors.push(`Tình trạng bệnh không hợp lệ. Giá trị hiện tại: "${careNeeds}"`);
                    document.getElementById('careNeeds').classList.add('is-invalid');
                }

                if (!price || parseInt(price) <= 0) {
                    errors.push(`Giá mong muốn phải lớn hơn 0. Giá trị hiện tại: "${price}"`);
                    document.getElementById('price').classList.add('is-invalid');
                }

                if (errors.length > 0) {
                    e.preventDefault();
                    console.log("Validation Errors:", errors);
                    alert("Có lỗi xảy ra:\n" + errors.join("\n"));
                }
            });

            // Address Autocomplete
            const addressInput = document.getElementById('address');
            const addressSuggestions = document.getElementById('addressSuggestions');
            
            // Danh sách địa chỉ gợi ý Việt Nam
            const vietnamAddresses = [
                "123 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "456 Lê Lợi, Quận 1, TP. Hồ Chí Minh", 
                "789 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "321 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "654 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "987 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "147 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "258 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "369 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "741 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "852 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "963 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "159 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "357 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "468 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "579 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "680 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "791 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "802 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "913 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "24 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "35 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "46 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "57 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "68 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "79 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "80 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "91 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "102 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "113 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "124 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "135 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "146 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "157 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "168 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "179 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "180 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "191 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "202 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "213 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "224 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "235 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "246 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "257 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "268 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "279 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "280 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "291 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "302 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "313 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "324 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "335 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "346 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "357 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "368 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "379 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "380 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "391 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "402 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "413 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "424 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "435 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "446 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "457 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "468 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "479 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "480 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "491 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "502 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "513 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "524 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "535 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "546 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "557 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "568 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "579 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "580 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "591 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "602 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "613 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "624 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "635 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "646 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "657 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "668 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "679 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "680 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "691 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "702 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "713 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "724 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "735 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "746 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "757 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "768 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "779 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "780 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "791 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "802 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "813 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "824 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "835 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "846 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "857 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "868 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "879 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "880 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "891 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "902 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "913 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "924 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "935 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "946 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "957 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "968 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "979 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "980 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "991 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1002 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1013 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1024 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "1035 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "1046 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "1057 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "1068 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1079 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1080 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "1091 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1102 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "1113 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1124 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1135 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "1146 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "1157 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "1168 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "1179 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "1180 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "1191 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "1202 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1213 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "1224 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1235 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "1246 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1257 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1268 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1279 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "1280 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "1291 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "1302 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "1313 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1324 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1335 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "1346 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1357 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "1368 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1379 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1380 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "1391 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "1402 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "1413 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "1424 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "1435 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "1446 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "1457 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1468 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "1479 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1480 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "1491 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1502 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1513 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1524 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "1535 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "1546 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "1557 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "1568 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1579 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1580 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "1591 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1602 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "1613 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1624 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1635 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "1646 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "1657 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "1668 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "1679 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "1680 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "1691 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "1702 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1713 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "1724 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1735 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "1746 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1757 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1768 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1779 Phạm Ngũ Lão, Quận 1, TP. Hồ Chí Minh",
                "1780 Bùi Viện, Quận 1, TP. Hồ Chí Minh",
                "1791 Đề Thám, Quận 1, TP. Hồ Chí Minh",
                "1802 Nguyễn Thái Học, Quận 1, TP. Hồ Chí Minh",
                "1813 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1824 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1835 Lê Lợi, Quận 1, TP. Hồ Chí Minh",
                "1846 Điện Biên Phủ, Quận Bình Thạnh, TP. Hồ Chí Minh",
                "1857 Cách Mạng Tháng 8, Quận 10, TP. Hồ Chí Minh",
                "1868 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "1879 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh",
                "1880 Đinh Tiên Hoàng, Quận 1, TP. Hồ Chí Minh",
                "1891 Nguyễn Du, Quận 1, TP. Hồ Chí Minh",
                "1902 Pasteur, Quận 3, TP. Hồ Chí Minh",
                "1913 Hai Bà Trưng, Quận 1, TP. Hồ Chí Minh",
                "1924 Nguyễn Trãi, Quận 5, TP. Hồ Chí Minh",
                "1935 Lý Tự Trọng, Quận 1, TP. Hồ Chí Minh",
                "1946 Trần Hưng Đạo, Quận 1, TP. Hồ Chí Minh",
                "1957 Nguyễn Thị Nghĩa, Quận 1, TP. Hồ Chí Minh",
                "1968 Đồng Khởi, Quận 1, TP. Hồ Chí Minh",
                "1979 Nguyễn Huệ, Quận 1, TP. Hồ Chí Minh",
                "1980 Lê Duẩn, Quận 1, TP. Hồ Chí Minh",
                "1991 Nguyễn Thị Minh Khai, Quận 3, TP. Hồ Chí Minh",
                "2002 Võ Văn Tần, Quận 3, TP. Hồ Chí Minh"
            ];

            // Hàm tìm kiếm địa chỉ
            function searchAddresses(query) {
                if (query.length < 2) return [];
                
                return vietnamAddresses.filter(address => 
                    address.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10); // Chỉ hiển thị 10 kết quả đầu tiên
            }

            // Hàm hiển thị gợi ý
            function showSuggestions(suggestions) {
                if (suggestions.length === 0) {
                    addressSuggestions.style.display = 'none';
                    return;
                }

                addressSuggestions.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'address-suggestion-item';
                    item.innerHTML = `
                        <div class="suggestion-text">${suggestion}</div>
                        <div class="suggestion-detail">Địa chỉ tại TP. Hồ Chí Minh</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        addressInput.value = suggestion;
                        addressSuggestions.style.display = 'none';
                    });
                    
                    addressSuggestions.appendChild(item);
                });
                
                addressSuggestions.style.display = 'block';
            }

            // Xử lý sự kiện input
            addressInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                const suggestions = searchAddresses(query);
                showSuggestions(suggestions);
            });

            // Ẩn gợi ý khi click ra ngoài
            document.addEventListener('click', (e) => {
                if (!addressInput.contains(e.target) && !addressSuggestions.contains(e.target)) {
                    addressSuggestions.style.display = 'none';
                }
            });

            // Xử lý phím tắt
            addressInput.addEventListener('keydown', (e) => {
                const suggestions = addressSuggestions.querySelectorAll('.address-suggestion-item');
                let selectedIndex = -1;
                
                suggestions.forEach((item, index) => {
                    if (item.classList.contains('selected')) {
                        selectedIndex = index;
                    }
                });

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (selectedIndex < suggestions.length - 1) {
                        suggestions[selectedIndex]?.classList.remove('selected');
                        suggestions[selectedIndex + 1].classList.add('selected');
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (selectedIndex > 0) {
                        suggestions[selectedIndex]?.classList.remove('selected');
                        suggestions[selectedIndex - 1].classList.add('selected');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0) {
                        addressInput.value = suggestions[selectedIndex].querySelector('.suggestion-text').textContent;
                        addressSuggestions.style.display = 'none';
                    }
                } else if (e.key === 'Escape') {
                    addressSuggestions.style.display = 'none';
                }
            });

            // Auto Location Button
            const autoLocationBtn = document.getElementById('autoLocationBtn');
            const clearAddressBtn = document.getElementById('clearAddressBtn');

            // Hàm lấy vị trí hiện tại
            function getCurrentLocation() {
                if (!navigator.geolocation) {
                    alert('Trình duyệt không hỗ trợ định vị địa lý');
                    return;
                }

                autoLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang lấy vị trí...';
                autoLocationBtn.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        console.log('Current position:', lat, lng);
                        
                        // Sử dụng reverse geocoding để chuyển đổi tọa độ thành địa chỉ
                        reverseGeocode(lat, lng);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        let errorMessage = 'Không thể lấy vị trí: ';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Người dùng từ chối quyền truy cập vị trí';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Thông tin vị trí không khả dụng';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Hết thời gian chờ lấy vị trí';
                                break;
                            default:
                                errorMessage += 'Lỗi không xác định';
                                break;
                        }
                        
                        alert(errorMessage);
                        resetAutoLocationBtn();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }

            // Hàm reverse geocoding (chuyển đổi tọa độ thành địa chỉ)
            function reverseGeocode(lat, lng) {
                // Sử dụng Nominatim (OpenStreetMap) API miễn phí
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&accept-language=vi`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Reverse geocoding result:', data);
                        
                        if (data && data.display_name) {
                            // Tạo địa chỉ từ thông tin chi tiết
                            let address = '';
                            
                            if (data.address) {
                                const addr = data.address;
                                
                                // Xây dựng địa chỉ từ các thành phần
                                if (addr.house_number) address += addr.house_number + ' ';
                                if (addr.road) address += addr.road + ', ';
                                if (addr.suburb) address += addr.suburb + ', ';
                                if (addr.city_district) address += addr.city_district + ', ';
                                if (addr.city) address += addr.city + ', ';
                                if (addr.state) address += addr.state;
                                
                                // Nếu không có địa chỉ chi tiết, sử dụng display_name
                                if (!address.trim()) {
                                    address = data.display_name;
                                }
                            } else {
                                address = data.display_name;
                            }
                            
                            // Cập nhật vào ô địa chỉ
                            addressInput.value = address;
                            
                            // Hiển thị thông báo thành công
                            showNotification('Đã cập nhật địa chỉ tự động!', 'success');
                        } else {
                            throw new Error('Không thể lấy địa chỉ từ tọa độ');
                        }
                        
                        resetAutoLocationBtn();
                    })
                    .catch(error => {
                        console.error('Reverse geocoding error:', error);
                        alert('Không thể chuyển đổi vị trí thành địa chỉ: ' + error.message);
                        resetAutoLocationBtn();
                    });
            }

            // Hàm reset nút auto location
            function resetAutoLocationBtn() {
                autoLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt me-1"></i>Cập nhật địa chỉ tự động';
                autoLocationBtn.disabled = false;
            }

            // Hàm hiển thị thông báo
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(notification);
                
                // Tự động ẩn sau 3 giây
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // Event listeners cho các nút
            autoLocationBtn.addEventListener('click', getCurrentLocation);
            
            clearAddressBtn.addEventListener('click', () => {
                addressInput.value = '';
                addressSuggestions.style.display = 'none';
                showNotification('Đã xóa địa chỉ!', 'info');
            });
        });
    </script>
}